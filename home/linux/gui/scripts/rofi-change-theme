#!/usr/bin/env bash

# --- Configuration ---
NIX_FLAKE_PATH="${NIX_FLAKE_PATH:-$HOME/.config/nix}"
STYLIX_TARGET_IMAGE="$NIX_FLAKE_PATH/current.png"

WALLPAPER_DIR="${WALLPAPER_DIR:-$HOME/Pictures/Wallpapers}"
GRID_THEME="${GRID_THEME:-$HOME/.config/rofi/grid.rasi}"
ROFI="rofi"
rofi_flags="-normal-window"

# --- Validation ---
if [ ! -d "$WALLPAPER_DIR" ]; then
  $ROFI $rofi_flags -e "Wallpaper directory not found: $WALLPAPER_DIR"
  exit 1
fi

# --- Generate Entries ---
generate_entries() {
  find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) |
    while read -r wallpaper; do
      printf "%s\0icon\x1f%s\n" "$(basename "$wallpaper")" "$wallpaper"
    done
}

# --- Selection ---
chosen_filename=$(generate_entries | $ROFI $rofi_flags -theme "$GRID_THEME" -dmenu -i -p "Wallpaper")

if [ -n "$chosen_filename" ]; then
  chosen_wallpaper_path="$WALLPAPER_DIR/$chosen_filename"

  cp "$chosen_wallpaper_path" "$STYLIX_TARGET_IMAGE"

  if [ -d "$NIX_FLAKE_PATH/.git" ]; then
    cd "$NIX_FLAKE_PATH" && git add "$STYLIX_TARGET_IMAGE"
  fi

  if command -v nh &>/dev/null; then
    notify-send "Theme Switcher" "Wallpaper updated. Rebuilding..."

    if nh os switch --ask "$NIX_FLAKE_PATH"; then
      notify-send "Theme Switcher" "Style applied successfully!"
    else
      notify-send "Theme Switcher" "Rebuild failed!" -u critical
    fi
  else
    notify-send "Theme Switcher" "nh not found. Run rebuild manually."
  fi
fi
