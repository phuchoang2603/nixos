#!/usr/bin/env bash

tmp_dir="/tmp/cliphist"
mkdir -p "$tmp_dir"

# --- 1. HANDLE SELECTION ---
if [[ -n "${1:-}" ]]; then
  # Use printf to preserve the exact tab character between ID and content
  printf "%s" "$1" | cliphist decode | wl-copy
  exit 0
fi

# --- 2. GENERATE ENTRIES ---
generate_entries() {
  # cliphist list format is "<id>\t<preview>"
  cliphist list | head -n 50 | while read -r line; do
    if [[ "$line" == *'[[ binary'* ]]; then
      id=$(echo "$line" | cut -f1)
      img_path="$tmp_dir/$id.png"

      # Decode only if image isn't cached
      if [[ ! -f "$img_path" ]]; then
        cliphist decode <<<"$line" >"$img_path" 2>/dev/null
      fi

      # Full line is passed to Rofi, but column 1 is hidden later
      echo -en "$line\0icon\x1f$img_path\n"
    else
      echo "$line"
    fi
  done
}

# --- 3. RUN ROFI ---
# -display-columns 2: Hides the ID number column
# wrap: true + nlines: 3: Simulates text wrapping and makes rows taller
chosen=$(generate_entries | rofi -dmenu -i -p "Clipboard" \
  -display-columns 2 \
  -show-icons \
  -theme-str 'element-icon { size: 12ch; }' \
  -theme-str 'element-text { vertical-align: 0.5; wrap: true; nlines: 3; }' \
  -theme-str 'listview { fixed-height: false; }')

if [[ -n "$chosen" ]]; then
  "$0" "$chosen"
fi
