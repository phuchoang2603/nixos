#!/usr/bin/env bash

# Path to your new grid theme
GRID_THEME="$HOME/.config/rofi/grid.rasi"
# Path to your wallpapers
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
# Destination for current wallpaper (in nix config)
NIX_CONFIG_DIR="$HOME/.config/nix"
CURRENT_WALLPAPER_PATH="$NIX_CONFIG_DIR/current.png"

ROFI="${ROFI:-rofi}"
rofi_flags="-normal-window"

# Check if wallpaper directory exists
if [ ! -d "$WALLPAPER_DIR" ]; then
  $ROFI $rofi_flags -e "Wallpaper directory not found: $WALLPAPER_DIR"
  exit 1
fi

# Generate entries using printf for reliability
generate_entries() {
  find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) |
    while read -r wallpaper; do
      filename=$(basename "$wallpaper")
      # Use printf for safer escape sequence handling
      printf "%s\0icon\x1f%s\n" "$filename" "$wallpaper"
    done
}

# Check if any wallpapers were found
if ! find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) -print -quit | grep -q .; then
  $ROFI $rofi_flags -e "No wallpapers found in $WALLPAPER_DIR"
  exit 1
fi

# Let the user choose a wallpaper. Rofi will output the filename.
chosen_filename=$(generate_entries | $ROFI $rofi_flags -theme "$GRID_THEME" -dmenu -i -p "Wallpaper")

# If a wallpaper was chosen, apply it
if [ -n "$chosen_filename" ]; then
  chosen_wallpaper_path="$WALLPAPER_DIR/$chosen_filename"

  # Copy wallpaper to nix config directory
  cp "$chosen_wallpaper_path" "$CURRENT_WALLPAPER_PATH"

  # Rebuild NixOS configuration to apply new theme
  if command -v sudo >/dev/null 2>&1; then
    sudo nixos-rebuild switch
  else
    nixos-rebuild switch
  fi

  notify-send "Theme Switcher" "Wallpaper changed and NixOS rebuilt"
fi

exit 0
